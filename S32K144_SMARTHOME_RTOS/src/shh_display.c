#include "shh_display.h"
#include "drivers/gpio_driver.h"
#include "drivers/lpi2c_driver.h"
#include "drivers/lpit_driver.h"
#include "sh_config.h"
#include <string.h>


static uint8_t g_fnd_buffer[6] = {0,};
static uint8_t g_fnd_scan_digit = 0;

static const uint8_t g_fnd_patterns[10] = {
    // gfedcba
    0x3F, // 0 (0b00111111)
    0x06, // 1 (0b00000110)
    0x5B, // 2 (0b01011011)
    0x4F, // 3 (0b01001111)
    0x66, // 4 (0b01100110)
    0x6D, // 5 (0b01101101)
    0x7D, // 6 (0b01111101)
    0x07, // 7 (0b00000111)
    0x7F, // 8 (0b01111111)
    0x6F  // 9 (0b01101111)
};

#pragma GCC diagnostic push
#pragma GCC diagnostic ignored "-Wpedantic"
static const sh_port_pin_t g_fnd_data_pins[7] = {
    PIN_FND_DATA_A, PIN_FND_DATA_B, PIN_FND_DATA_C, PIN_FND_DATA_D, PIN_FND_DATA_E, PIN_FND_DATA_F, PIN_FND_DATA_G
};
static const sh_port_pin_t g_fnd_sel_pins[6] = {
    PIN_FND_SEL1, PIN_FND_SEL2, PIN_FND_SEL3, PIN_FND_SEL4, PIN_FND_SEL5, PIN_FND_SEL6
};
#pragma GCC diagnostic pop

static void _SHH_OLED_SendCommand(uint8_t cmd);
static void _SHH_OLED_SendData(uint8_t* data, uint32_t len);

void SHH_Display_Init(void) {

    // FND 전부 끄기
    for(int i = 0; i < 6; i++) {
        SHD_GPIO_WritePin(g_fnd_sel_pins[i], 0); // Common Cathod
    }

    // SSD1306 초기화 시퀀스
    _SHH_OLED_SendCommand(0xAE); // Display OFF
    _SHH_OLED_SendCommand(0xD5); // Set Display Clock Divide Ratio/Oscillator Frequency
    _SHH_OLED_SendCommand(0x80);
    _SHH_OLED_SendCommand(0xA8); // Set MUX Ratio
    _SHH_OLED_SendCommand(0x3F); // 128x64
    _SHH_OLED_SendCommand(0xD3); // Set Display Offset
    _SHH_OLED_SendCommand(0x00);
    _SHH_OLED_SendCommand(0x40); // Set Display Start Line
    _SHH_OLED_SendCommand(0x8D); // Charge Pump Setting
    _SHH_OLED_SendCommand(0x14); // Enable Charge Pump
    _SHH_OLED_SendCommand(0x20); // Set Memory Addressing Mode
    _SHH_OLED_SendCommand(0x00); // Horizontal Addressing Mode
    _SHH_OLED_SendCommand(0xA1); // Set Segment Re-map (column 127 -> SEG0)
    _SHH_OLED_SendCommand(0xC8); // Set COM Output Scan Direction (re-mapped)
    _SHH_OLED_SendCommand(0xDA); // Set COM Pins Hardware Configuration
    _SHH_OLED_SendCommand(0x12);
    _SHH_OLED_SendCommand(0x81); // Set Contrast Control
    _SHH_OLED_SendCommand(0xCF);
    _SHH_OLED_SendCommand(0xD9); // Set Pre-charge Period
    _SHH_OLED_SendCommand(0xF1);
    _SHH_OLED_SendCommand(0xDB); // Set VCOMH Deselect Level
    _SHH_OLED_SendCommand(0x40);
    _SHH_OLED_SendCommand(0xA4); // Entire Display ON (Resume)
    _SHH_OLED_SendCommand(0xA6); // Set Normal Display
    _SHH_OLED_SendCommand(0xAF); // Display ON

    SHH_OLED_Clear();
}


/** 
 *********************** FND ************************
 * Common Cathod -> 1써서 led 켬
*/

void SHH_FND_BufferUpdate(uint32_t number) {

    // 밝기 저장: PIN_FND_SEL5, 6
    g_fnd_buffer[5] = number % 10;
    g_fnd_buffer[4] = (number / 10) % 10;
    
    // 습도 저장: PIN_FND_SEL3, 4
    g_fnd_buffer[3] = (number / 100) % 10;
    g_fnd_buffer[2] = (number / 1000) % 10;

    // 온도 저장: PIN_FND_SEL1, 2
    g_fnd_buffer[1] = (number / 10000) % 10;
    g_fnd_buffer[0] = (number / 100000) % 10;
}

void SHH_FND_Display(void) {

    // 1. 모든 자릿수 끄기
    for(int i = 0; i < 6; i++) {
        SHD_GPIO_WritePin(g_fnd_sel_pins[i], 0); // Common Cathod
    }

    // 2. 현재 자릿수에 해당하는 숫자 패턴 출력
    uint8_t pattern = g_fnd_patterns[g_fnd_buffer[g_fnd_scan_digit]];
    for(int i = 0; i < 7; i++) {
        if((pattern >> i) & 1) {
            SHD_GPIO_WritePin(g_fnd_data_pins[i], 1);
        } else {
            SHD_GPIO_WritePin(g_fnd_data_pins[i], 0);
        }
    }

    // 3. 현재 자릿수만 켜기
    SHD_GPIO_WritePin(g_fnd_sel_pins[g_fnd_scan_digit], 1);

    // 4. 다음 스캔을 위해 자릿수 이동
    g_fnd_scan_digit++;
    if (g_fnd_scan_digit >= 6) {
        g_fnd_scan_digit = 0;
    }
}


/** 
 *********************** OLED ************************
*/

// OLED 제어를 위한 내부 헬퍼 함수
static void _SHH_OLED_SendCommand(uint8_t cmd);
static void _SHH_OLED_SendData(uint8_t* data, uint32_t len);

// OLED 5x7 ASCII 폰트 데이터 (' ' 부터 '~' 까지)
static const uint8_t g_font_5x7[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, // 0x20 ' '
    0x00, 0x00, 0x5F, 0x00, 0x00, // 0x21 '!'
    0x00, 0x07, 0x00, 0x07, 0x00, // 0x22 '"'
    0x14, 0x7F, 0x14, 0x7F, 0x14, // 0x23 '#'
    0x24, 0x2A, 0x7F, 0x2A, 0x12, // 0x24 '$'
    0x23, 0x13, 0x08, 0x64, 0x62, // 0x25 '%'
    0x36, 0x49, 0x55, 0x22, 0x50, // 0x26 '&'
    0x00, 0x05, 0x03, 0x00, 0x00, // 0x27 '''
    0x00, 0x1C, 0x22, 0x41, 0x00, // 0x28 '('
    0x00, 0x41, 0x22, 0x1C, 0x00, // 0x29 ')'
    0x14, 0x08, 0x3E, 0x08, 0x14, // 0x2A '*'
    0x08, 0x08, 0x3E, 0x08, 0x08, // 0x2B '+'
    0x00, 0x50, 0x30, 0x00, 0x00, // 0x2C ','
    0x08, 0x08, 0x08, 0x08, 0x08, // 0x2D '-'
    0x00, 0x60, 0x60, 0x00, 0x00, // 0x2E '.'
    0x20, 0x10, 0x08, 0x04, 0x02, // 0x2F '/'

    0x3E, 0x51, 0x49, 0x45, 0x3E, // 0x30 '0'
    0x00, 0x42, 0x7F, 0x40, 0x00, // 0x31 '1'
    0x42, 0x61, 0x51, 0x49, 0x46, // 0x32 '2'
    0x21, 0x41, 0x45, 0x4B, 0x31, // 0x33 '3'
    0x18, 0x14, 0x12, 0x7F, 0x10, // 0x34 '4'
    0x27, 0x45, 0x45, 0x45, 0x39, // 0x35 '5'
    0x3C, 0x4A, 0x49, 0x49, 0x30, // 0x36 '6'
    0x01, 0x71, 0x09, 0x05, 0x03, // 0x37 '7'
    0x36, 0x49, 0x49, 0x49, 0x36, // 0x38 '8'
    0x06, 0x49, 0x49, 0x29, 0x1E, // 0x39 '9'
    0x00, 0x36, 0x36, 0x00, 0x00, // 0x3A ':'
    0x00, 0x56, 0x36, 0x00, 0x00, // 0x3B ';'
    0x08, 0x14, 0x22, 0x41, 0x00, // 0x3C '<'
    0x14, 0x14, 0x14, 0x14, 0x14, // 0x3D '='
    0x00, 0x41, 0x22, 0x14, 0x08, // 0x3E '>'
    0x02, 0x01, 0x51, 0x09, 0x06, // 0x3F '?'

    0x32, 0x49, 0x79, 0x41, 0x3E, // 0x40 '@'
    0x7E, 0x11, 0x11, 0x11, 0x7E, // 0x41 'A'
    0x7F, 0x49, 0x49, 0x49, 0x36, // 0x42 'B'
    0x3E, 0x41, 0x41, 0x41, 0x22, // 0x43 'C'
    0x7F, 0x41, 0x41, 0x22, 0x1C, // 0x44 'D'
    0x7F, 0x49, 0x49, 0x49, 0x41, // 0x45 'E'
    0x7F, 0x09, 0x09, 0x09, 0x01, // 0x46 'F'
    0x3E, 0x41, 0x49, 0x49, 0x3A, // 0x47 'G'
    0x7F, 0x08, 0x08, 0x08, 0x7F, // 0x48 'H'
    0x00, 0x41, 0x7F, 0x41, 0x00, // 0x49 'I'
    0x20, 0x40, 0x41, 0x3F, 0x01, // 0x4A 'J'
    0x7F, 0x08, 0x14, 0x22, 0x41, // 0x4B 'K'
    0x7F, 0x40, 0x40, 0x40, 0x40, // 0x4C 'L'
    0x7F, 0x02, 0x0C, 0x02, 0x7F, // 0x4D 'M'
    0x7F, 0x04, 0x08, 0x10, 0x7F, // 0x4E 'N'
    0x3E, 0x41, 0x41, 0x41, 0x3E, // 0x4F 'O'

    0x7F, 0x09, 0x09, 0x09, 0x06, // 0x50 'P'
    0x3E, 0x41, 0x51, 0x21, 0x5E, // 0x51 'Q'
    0x7F, 0x09, 0x19, 0x29, 0x46, // 0x52 'R'
    0x46, 0x49, 0x49, 0x49, 0x31, // 0x53 'S'
    0x01, 0x01, 0x7F, 0x01, 0x01, // 0x54 'T'
    0x3F, 0x40, 0x40, 0x40, 0x3F, // 0x55 'U'
    0x1F, 0x20, 0x40, 0x20, 0x1F, // 0x56 'V'
    0x3F, 0x40, 0x38, 0x40, 0x3F, // 0x57 'W'
    0x63, 0x14, 0x08, 0x14, 0x63, // 0x58 'X'
    0x07, 0x08, 0x70, 0x08, 0x07, // 0x59 'Y'
    0x61, 0x51, 0x49, 0x45, 0x43, // 0x5A 'Z'
    0x00, 0x7F, 0x41, 0x41, 0x00, // 0x5B '['
    0x02, 0x04, 0x08, 0x10, 0x20, // 0x5C '\'
    0x00, 0x41, 0x41, 0x7F, 0x00, // 0x5D ']'
    0x04, 0x02, 0x01, 0x02, 0x04, // 0x5E '^'
    0x40, 0x40, 0x40, 0x40, 0x40, // 0x5F '_'

    0x00, 0x01, 0x02, 0x04, 0x00, // 0x60 '`'
    0x20, 0x54, 0x54, 0x54, 0x78, // 0x61 'a'
    0x7F, 0x48, 0x44, 0x44, 0x38, // 0x62 'b'
    0x38, 0x44, 0x44, 0x44, 0x20, // 0x63 'c'
    0x38, 0x44, 0x44, 0x48, 0x7F, // 0x64 'd'
    0x38, 0x54, 0x54, 0x54, 0x18, // 0x65 'e'
    0x08, 0x7E, 0x09, 0x01, 0x02, // 0x66 'f'
    0x0C, 0x52, 0x52, 0x52, 0x3E, // 0x67 'g'
    0x7F, 0x08, 0x04, 0x04, 0x78, // 0x68 'h'
    0x00, 0x44, 0x7D, 0x40, 0x00, // 0x69 'i'
    0x20, 0x40, 0x44, 0x3D, 0x00, // 0x6A 'j'
    0x7F, 0x10, 0x28, 0x44, 0x00, // 0x6B 'k'
    0x00, 0x41, 0x7F, 0x40, 0x00, // 0x6C 'l'
    0x7C, 0x04, 0x18, 0x04, 0x78, // 0x6D 'm'
    0x7C, 0x08, 0x04, 0x04, 0x78, // 0x6E 'n'
    0x38, 0x44, 0x44, 0x44, 0x38, // 0x6F 'o'

    0x7C, 0x14, 0x14, 0x14, 0x08, // 0x70 'p'
    0x08, 0x14, 0x14, 0x14, 0x7C, // 0x71 'q'
    0x7C, 0x08, 0x04, 0x04, 0x08, // 0x72 'r'
    0x48, 0x54, 0x54, 0x54, 0x20, // 0x73 's'
    0x04, 0x3F, 0x44, 0x40, 0x20, // 0x74 't'
    0x3C, 0x40, 0x40, 0x20, 0x7C, // 0x75 'u'
    0x1C, 0x20, 0x40, 0x20, 0x1C, // 0x76 'v'
    0x3C, 0x40, 0x30, 0x40, 0x3C, // 0x77 'w'
    0x44, 0x28, 0x10, 0x28, 0x44, // 0x78 'x'
    0x0C, 0x50, 0x50, 0x50, 0x3C, // 0x79 'y'
    0x44, 0x64, 0x54, 0x4C, 0x44, // 0x7A 'z'
    0x00, 0x08, 0x36, 0x41, 0x00, // 0x7B '{'
    0x00, 0x00, 0x7F, 0x00, 0x00, // 0x7C '|'
    0x00, 0x41, 0x36, 0x08, 0x00, // 0x7D '}'
    0x08, 0x04, 0x08, 0x10, 0x08, // 0x7E '~'
};

void SHH_OLED_Clear(void) {
    uint8_t display_buffer[1024]; // 128 * (64 / 8) = 1024
    for(int i = 0; i < 1024; i++) {
        display_buffer[i] = 0x00;
    }
    _SHH_OLED_SendData(display_buffer, 1024);
}

void SHH_OLED_PrintString(uint8_t line, uint8_t col, const char* str) {
    // 1. 커서 위치 설정
    _SHH_OLED_SendCommand(0xB0 | line);                     // Set Page Start Address
    _SHH_OLED_SendCommand(0x00 | (col & 0x0F));           // Set Lower Column Start Address
    _SHH_OLED_SendCommand(0x10 | ((col >> 4) & 0x0F));    // Set Higher Column Start Address

    // 2. 문자열의 각 문자를 폰트 데이터로 변환하여 전송
    while (*str) {
        // ASCII 값에서 ' '(space)의 ASCII(32) 값을 빼서 폰트 배열 인덱스 계산
        uint16_t font_index = (*str - ' ') * 5;
        _SHH_OLED_SendData((uint8_t*)&g_font_5x7[font_index], 5);

        // 글자 사이에 공백 1픽셀 추가
        uint8_t space = 0x00;
        _SHH_OLED_SendData(&space, 1);

        str++;
    }
}

static void _SHH_OLED_SendCommand(uint8_t cmd){

    uint8_t cmd_buffer[2] = {0x00, cmd}; // Control byte for command is 0x00
    SHD_LPI2C0_Write(SSD1306_OLED_ADDR, cmd_buffer, 2);
}

static void _SHH_OLED_SendData(uint8_t* data, uint32_t len) {

    uint8_t data_buffer[len + 1];
    data_buffer[0] = 0x40; // Control byte for data is 0x40
    memcpy(&data_buffer[1], data, len);
    SHD_LPI2C0_Write(SSD1306_OLED_ADDR, data_buffer, len + 1);
}

